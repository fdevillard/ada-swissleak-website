<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>ADA: SwissLeak</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="css/custom.css">

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="images/favicon.png">

  <!-- JS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <script type="text/javascript" src="js/plotly-latest.min.js"></script>

</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">
    <div class="row">
      <div class="two-thirds column" style="margin-top:10%">
        <h1>SwissLeak project</h1>
        <p>Published information has been collected carefully but no guarantee
        about its completeness, correctness or up-to-date nature is given.</p>
        <p> No liability is accepted for damage or loss incurred from any 
        information obtained in this website</p>
      </div>
      <div class="one-third column" style="margin-top:10%">
        <img src="images/ADA-logo.png" class="u-max-full-width" />
      </div>
    </div>
  </div>

  <div class="container values">
    <div class="row">
      <div class="one-third column value-header">Lionel Fleury</div>
      <div class="one-third column value-header">Semion Sidorenko</div>
      <div class="one-third column value-header">Florent Devillard</div>
    </div>
  </div>

  <div class="container">
    <h2>Timelapse</h2>
    <div class="row">
      <p>This plot gives inside about the different activities around the Panama
      Papers.</p>
      <p>The year means how many entities became invalid, while the <em>still
        active</em> means entities which were still active late 2015.</p>
    </div>
    <div class="row">
      <div class="three columns">
        <button class="primary-button" onclick="next_year()">Next Year</button>
      </div>
      <div class="three columns">
        <button class="primary-button" onclick="set_now()">Still active</button>
      </div>
      <div class="three columns">
        <button class="primary-button" onclick="animate()">Animate</button>
      </div>
      <div class="three columns">
        <p id="current_year"><p>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <div id="tester" class="u-max-full-width"></div>
      </div>
    </div>
  </div>

<!-- Let's scripting
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->

<script>

var root_data  = undefined;
var plot_div = document.getElementById('tester');
var all_years = undefined;
var current_year = "2015";
var timer = undefined;

function set_now() {
  update_with_year("-1");
}

function animate() {
  if (typeof timer !== "undefined") {
    clearInterval(timer);
  }

  function handler() {
    current_year_idx = all_years.indexOf(current_year);

    if(current_year_idx+1 == all_years.length) {
      clearInterval(timer);
      timer = undefined;
    } else {
      next_year();   
    }
  }

  update_with_year(all_years[0]);
  timer = setInterval(handler, 600);
}

function update_year_label() {
  var text_value = undefined;
  var current_year_as_int = parseInt(current_year);
  console.log(current_year_as_int);
  if (parseInt(current_year) < 0)
    text_value = "Still active";
  else 
    text_value = current_year
  document.getElementById('current_year').innerHTML = text_value;
}

function update_with_year(new_year) {
  current_year = new_year;
  update_year_label();
  data = plot_div.data[0];
  new_data = root_data[new_year];

  data.locations = new_data.locations;
  data.text = new_data.locations;
  data.z = new_data.values;

  Plotly.redraw(plot_div);
}

function next_year() {
  var index = all_years.indexOf(current_year)
  if(index < 0) {
    throw "Illegal State: "+index+" ("+current_year+")";
  }

  var next_index = (index + 1) % all_years.length;
  var new_year = all_years[next_index];
  
  update_with_year(new_year);
  console.log("Updated map, year is now: "+new_year)
} 

Plotly.d3.json('https://raw.githubusercontent.com/fdevillard/ada-swissleak-website/master/data/number_closing_account_per_year_bis3.json',
  function(err, data_json){
    root_data = data_json;
    all_years = Object.keys(data_json);

    yearly_data = data_json[current_year];

    console.log(yearly_data);
    
    var data = [{
      type: 'choropleth',
      //locationmode: 'ISO-3',
      locations: yearly_data['locations'],
      z: yearly_data['values'],
      text: yearly_data['locations'],
      autocolorscale: true
    }];

    var layout = {
      height: 800,
      width: 800,
      geo: {
        projection: {
          type: 'mercator'
        }
      }
    };

    Plotly.plot(tester, data, layout, {showLink: false});
    

  });
</script>

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>
